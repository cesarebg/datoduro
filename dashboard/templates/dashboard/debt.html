{% load static %}
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="{% static 'dashboard/style/style.css' %}">
  <script src="{% static 'dashboard/javascript/d3.js' %}"></script>
  <link href="https://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <title>Debt | The Brexit Dashboard</title>
</head>

<body>
  <div class="inflation_header">
    <h2 class="article_title">Debt burden pressures for more austerity</h2>
    <img src="/static/dashboard/img/treasury_medium.jpg" id="front_image_debt"></img>
    <div id="vis_debt"></div>
  </div>
  <div id="auto_text"></div>
  <div>
    <form method="post" action="/data/deficit/" id="deficit">
      {% csrf_token %}
      <button class="indicator_botton" id="deficit_button" type="botton">Deficit</button>
    </form>
    <form method="post" action="/data/debt/" id="debt">
      {% csrf_token %}
      <button class="indicator_botton" id="debt_button" type="botton">Debt</button>
    </form>
  </div>

  <article>
    <p>
      Since the referendum, not only businesses and consumers have lost confidence and felt uncertainty about the future of the economy. The international market also issued a warning, when all the three-major bond credit rating agencies downgraded the UK’s
      rating, a move that may increase the cost of debt, hence straining the capacity of the government to invest in social welfare after seven years of austerity.<br><br> Brexit is slowing growth, and that translates into less income to reduce
      the deficit and public debt. Also, the Brexit vote hit the pound, increasing consumer prices and tightening living standards, which in turn cut the household spending in services, the primary economic activity in the UK.<br><br> This outlook alerted
      credit agencies. Moody’s downgraded UK’s long-term rating to Aaa2 from Aa1 and changed the outlook to stable from negative last September. The same agency downgraded the score from the highest AAA mark to Aa1 in 2013 amid concerns of sluggish growth
      and the rise of the debt burden.<br><br> Just after the Brexit vote, Fitch downgraded the UK’s rating to AA from AA+, the highest rating, and changed the outlook to negative. Likewise, S&P downgraded the rating after the referendum in 2016 to AA
      with a negative outlook.<br><br> Two main factors prompted Moody´s to downgrade UK’s rating this year. The first one concerning with the inherent weakness of British public finances and the second it was related to Brexit:<br><br> “Fiscal pressures
      will be exacerbated by the erosion of the UK's medium-term economic strength that is likely to result from the manner of its departure from the European Union (EU), and by the increasingly apparent challenges to policy-making given the complexity
      of Brexit negotiations and associated domestic political dynamics”, according to the latest rating action by Moody’s.<br><br>

      <strong class="article_sub">Deficit and debt burden, persistent problems</strong><br><br> Since the Brexit vote in June 2016, the government debt reached 87% –£1.8 trillion– of the GDP last September according to the ONS. However, the debt has been
      increasing steadily since the financial crisis of 2008. Early that year the deficit was only 34% of UK’s economic output.<br><br> In the last financial year, the public-sector net borrowing, also known as the deficit, was 2.3% of the GDP, which
      represented an annual decrease of £28 billion pounds. The deficit has declined substantially after seven years of spending cuts. In 2010, it reached almost 10% of the GDP, just after two years of the onset of the financial crisis, according to the
      ONS.<br><br> However, Brexit may trigger an economic downturn, and unleash further uncertainty, reducing investment and trade, which may translate into less government income.<br><br> “The UK government is still running a deficit and borrowing more
      each year, so that is being added to the debt”, said in a telephone interview, Malcolm Sawyer, academic from the University of Leeds. “The absolute amount of the debt has been rising and will continue to rise relative to the GDP, especially since
      growth has been slow”.<br><br> “The government has tried to cut the deficit, but you have to look at the other side of the equation: the deficit is going to decline with a combination of investments, rising relative to savings or net exports, but
      that hasn’t happened in sufficient amounts”, he added. “Also, there is the problem of austerity that tends to make private spending lower, so the taxes that come from the private sector maybe not much as anticipated”.<br><br> The government may
      still meet the goals of reducing deficit, according to the Office for Budget Responsibility (OBR, 2017). However, it is not expected to return balance to public finances in the next Parliament.<br><br> “The deficit falls little in 2020-21 and 2021-22,
      while the ageing population and cost pressures in health are likely to put upward pressure on the deficit in the next Parliament”, according to the Official for Budget Responsibility.<br><br> Moody’s, Standard & Poor’s (S&P) and Fitch ratings are
      used by financial institutions to determine the cost of credit to their lenders. Therefore, governments can experience financial pressure from private investors through credit agencies if the performance of public finances is not within the expectations.
      This pressure and some of their recommendations may go against public interest in some cases.<br><br> “Credit rating agencies do have a record of pressuring countries like Greece and creating problems. I think the overall UK economic situation is
      worsened by Brexit or will be”, said Sawyer.<br><br> “Investment must be undertaken by the government or private companies. But investment in its nature, requires borrowing, and if your credit ratings are being reduced, the government cannot borrow
      as much, then you can be locked into a dangerous situation”, he added.<br><br> One of the main concerns of Moody’s is the current intention of the UK government to increase spending. The agency perceive weakness in UK’s public finances, and their
      incapacity to reduce debt burden, even after seven years of austerity in areas such as social welfare.<br><br> “Since 2015, the government has been finding it increasingly difficult to implement the spending cuts that it has been targeting, in particular
      on welfare spending. More recently, the government has yielded to pressure and raised spending in several areas”, according to the last rating action by Moody’s.<br><br> The UK government cut spending after the financial crisis as one of the measures
      to stabilise the economy. The public expenditure on services was reduced to 37% of the GDP in 2016, from 42% in 2010. This type of spending has remained stagnant at around £700 billion pounds, according to the Treasury.<br><br> Most services experienced
      a cut in that period. For instance, Education spending was reduced to 4.4% of the GDP in 2016 from 5.8% in 2010, a decline of more than £15 billion pounds. Health expenditure had also decreased in proportion to the size of the UK economy, to 7.3%
      of GDP in 2016, from 7.6% of GDP in 2010, even when the nominal value increased almost £11 billion pounds in that same period.<br><br> Housing, public order and defence expenditure also experienced cuts, and now they operate with resources below
      the budget before the financial crisis. Therefore, the UK government has less space to reduce spending in case Brexit has a significant impact on the economy.<br><br> Moody’s also showed concern about the arrangement between the government and the
      Democratic Unionist Party (DUP) to reach parliamentary majority. The agreement includes spending one billion pounds in Northern Ireland. Furthermore, the government is expected to keep the same sources of income, since the plan to increase national
      insurance contributions for the self-employed was abandoned.<br><br> In addition to these measures, Moody’s has no longer confidence on the capacity of the UK government to reach a free trade agreement with the EU before 2019, a scenario that will
      harm growth in the coming years mainly by a substantial lower trade with the UK’s main economic partner, and therefore:<br><br> “The loss of economic strength will further exacerbate pressures on fiscal consolidation (..) While future years may
      see some recovery, Moody's expects growth of just 1% in 2018 following 1.5% this year and 2.25% on average in recent years. More importantly for the UK's credit profile, Moody's does not expect growth to recover to its historical trend rate over
      the coming years”, said Moody’s.<br><br> Despite the pressure from international markets and credit rating agencies, it is very improbable that the UK gets into the same turmoil that countries such as Greece, Spain and Portugal experienced in the
      years after the financial crisis of 2008.<br><br> “It is much more difficult to be affected by credit rating agencies in the case of countries such as the UK, since is a very well-known economy with a broad management circle in London and the pound
      is a reserve currency”, said in a telephone interview, Panayotis Gavras, head of Policy and Strategy at Black Sea Trade and Development Bank.<br><br> “And also, right now, how investors perceive credit ratings is more decoupled than a few years
      back, and that is a good thing actually, because credit ratings are only an opinion, and everyone is entitled to one”, he added.<br><br> The UK economy still counts with many strengths, and there is not a perceived sense of panic in the financial
      sector in Europe because of Brexit, according to Gavras, “but nothing is impossible right now, and will see”. He also pointed out that in the end, credit agencies tend to qualify to the downside, and many countries have more trouble raising their
      rating, than having it downgraded, despite upgrades in their economic outlook.<br><br>
    </p>
    <p id="img-credit-Treasury">Image by <a href="https://www.flickr.com/photos/hmtreasury/3417058451/in/album-72157615594367123/" target="_blank">HM Treasury<a></p>


  </article>
</body>
<script src="{% static 'dashboard/vendor/jquery/jquery-3.2.1.min.js' %}"></script>
<script>
  var debt = {{ debt_json | safe }}
  console.log(debt[39]['text'])

  document.getElementById("auto_text").innerText = debt[39]['text']

  var margin = {
    top: 50,
    left: 60,
    right: 30,
    bottom: 60,
  };

  var width = 500;
  var height = 400;

  var svg = d3.select('#vis_debt')
    .append('svg')
    .attr('width', width)
    .attr('height', height)
    .append('g')
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

  svg.append("linearGradient")
    .attr("id", "line-gradient")
    .attr("gradientUnits", "userSpaceOnUse")
    .attr("x1", 0).attr("y1", "0%")
    .attr("x2", 0).attr("y2", "100%")
    .selectAll("stop")
    .data([{
        offset: "0%",
        color: "red"
      },
      {
        offset: "60%",
        color: "skyblue"
      },
      {
        offset: "100%",
        color: "skyblue"
      }
    ])
    .enter().append("stop")
    .attr("offset", function(d) {
      return d.offset;
    })
    .attr("stop-color", function(d) {
      return d.color;
    });

  var tooltip = d3.select('body')
    .append('div')
    .attr('class', 'tooltip');

  width = width - margin.left - margin.right;
  height = height - margin.top - margin.bottom;

  var dateParse = d3.timeParse('%Y %b');
  var tooltipFormat = d3.timeFormat('%b %Y');


  var x = d3.scaleTime()
    .range([0, width]);

  var y = d3.scaleLinear()
    .domain(d3.extent(debt, function(d) {
      return parseFloat(d.value);
    }))
    .range([height, 0]);

  var x_axis = d3.axisBottom(x)
  var y_axis = d3.axisLeft(y)

  svg.selectAll('#tags')
    .remove()

  svg.append('g')
    .attr("id", "tags")
    .attr('transform', 'translate(0,' + height + ')')
    .attr('class', 'x axis');

  // Labels

  svg.append('g')
    .attr("id", "tags")
    .attr('class', 'y axis')

  svg.append("text")
    .attr("id", "tags")
    .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.top) + ")")
    .style("text-anchor", "middle")
    .text("Quarters");

  // y label
  svg.append("text")
    .attr("id", "tags")
    .attr("transform", "rotate(-90)")
    .attr("y", 10 - margin.left)
    .attr("x", 0 - (height / 2))
    .attr("dy", "1em")
    .style("text-anchor", "middle")
    .text("Debt % of GDP");

  svg.append("text")
    .attr("id", "tags")
    .attr("x", (width / 2))
    .attr("y", 0 - (margin.top / 2))
    .attr("text-anchor", "middle")
    .style("font-size", "18px")
    .text("UK's debt burden is increasing");

  function make_x_gridlines() {
    return d3.axisBottom(x)
      .ticks(0);
  }

  function make_y_gridlines() {
    return d3.axisLeft(y)
      .ticks(10);
  }

  // add the X gridlines
  svg.append("g")
    .attr("id", "tags")
    .attr("class", "grid")
    .attr("transform", "translate(0," + height + ")")
    .call(make_x_gridlines()
      .tickSize(-height)
      .tickFormat("")
    );
  // add the Y gridlines
  svg.append("g")
    .attr("id", "tags")
    .attr("class", "grid")
    .call(make_y_gridlines()
      .tickSize(-width)
      .tickFormat("")
    );

  // function expenditure_pounds() {

  x.domain(d3.extent(debt, function(d) {
    return dateParse(d.date);
  }));

  y.domain(d3.extent(debt, function(d) {
    return parseFloat(d.value);
  }));

  var line = d3.line()
    .curve(d3.curveCatmullRom)
    .x(function(d) {
      return x(dateParse(d.date));
    })
    .y(function(d) {
      return y(d.value);
    });

  var lines = svg.selectAll('.line')
    .remove()
    .exit()
    .data([debt]);
  console.log(lines)

  lines
    .enter()
    .append('path')
    .attr('class', 'line')
    .attr("id", "tags")
    .attr('fill', 'none')
    // .attr('stroke', 'steelblue')
    .attr('d', line);

  var points = svg.selectAll('.point')
    .remove()
    .exit()
    .data(debt);

  points
    .enter()
    .append('circle')
    .attr('class', 'point')
    .attr("id", "tags")
    .attr('r', 3)
    .attr('cx', function(debt) {
      return x(dateParse(debt.date));
    })
    .attr('cy', function(debt) {
      return y(debt.value);
    })
    .attr('fill', 'black')
    .attr('opacity', 1)
    .on('mouseover', mouseOver)
    .on('mousemove', mouseMove)
    .on('mouseout', mouseOut);

  svg.select('.x.axis')
    .call(x_axis)
    .attr("id", "tags")
    .selectAll('text')
    .attr('transform', 'rotate(30)')
    .attr('y', '10')
    .attr('x', '0')
    .style("text-anchor", "start");

  svg.select('.y.axis')
    .attr("id", "tags")
    .call(y_axis);

  function mouseOver(d) {
    var date = dateParse(d.date);
    var displayDate = tooltipFormat(date)
    var value_function = d.value;

    d3.select(this)
      .transition()
      .style('opacity', 1);

    tooltip
      .style('display', null)
      .html('<p>UK debt was ' + value_function + '% of GDP in quarter ending ' + displayDate + '</p>');
  }

  function mouseMove(d) {
    tooltip
      .style('top', (d3.event.pageY - 20) + "px")
      .style('left', (d3.event.pageX + 20) + "px");
  }

  function mouseOut(d) {
    d3.select(this)
      .transition()
      .style('opacity', 1);

    tooltip
      .style('display', 'none');

  }

  $(document).on('submit', '#debt', function(e) {
    e.preventDefault();

    $.ajax({
      url: "/data/debt/",
      type: "POST", // or "get"
      data: {
        years: $('#select_dropdown').val(),
        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
      },
      success: function debt(debt) {

        svg.selectAll('#tags')
          .remove()

        svg.append("text")
          .attr("id", "tags")
          .attr("x", (width / 2))
          .attr("y", 0 - (margin.top / 2))
          .attr("text-anchor", "middle")
          .style("font-size", "18px")
          .text("UK's debt burden is increasing");

        svg.append("text")
          .attr("id", "tags")
          .attr("transform", "rotate(-90)")
          .attr("y", 10 - margin.left)
          .attr("x", 0 - (height / 2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text("Debt % of GDP");

        svg.append("text")
          .attr("id", "tags")
          .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.top) + ")")
          .style("text-anchor", "middle")
          .text("Quarters");

        var dateParse = d3.timeParse('%Y %b');
        var tooltipFormat = d3.timeFormat('%b %Y');

        x.domain(d3.extent(debt, function(d) {
          return dateParse(d.date);
        }));

        y.domain(d3.extent(debt, function(d) {
          return parseFloat(d.value);
        }));

        var x_axis = d3.axisBottom(x)
        var y_axis = d3.axisLeft(y)

        svg.append('g')
          .attr('transform', 'translate(0,' + height + ')')
          .attr('class', 'x axis');

        svg.append('g')
          .attr('class', 'y axis')

        function make_y_gridlines_deficit() {
          return d3.axisLeft(y)
            .ticks(10);
        }

        // add the Y gridlines
        svg.append("g")
          .attr("id", "tags")
          .attr("class", "grid")
          .call(make_y_gridlines_deficit()
            .tickSize(-width)
            .tickFormat("")
          );

        var line = d3.line()
          .curve(d3.curveCatmullRom)
          .x(function(d) {
            return x(dateParse(d.date));
          })
          .y(function(d) {
            return y(d.value);
          });

        var lines = svg.selectAll('.line')
          .remove()
          .exit()
          .data([debt]);
        console.log(lines)

        lines
          .enter()
          .append('path')
          .attr('class', 'line')
          .attr("id", "tags")
          .attr('fill', 'none')
          // .attr('stroke', 'steelblue')
          .attr('d', line);

        var points = svg.selectAll('.point')
          .remove()
          .exit()
          .data(debt);

        points
          .enter()
          .append('circle')
          .attr('class', 'point')
          .attr("id", "tags")
          .attr('r', 3)
          .attr('cx', function(debt) {
            return x(dateParse(debt.date));
          })
          .attr('cy', function(debt) {
            return y(debt.value);
          })
          .attr('fill', 'black')
          .attr('opacity', 1)
          .on('mouseover', mouseOver)
          .on('mousemove', mouseMove)
          .on('mouseout', mouseOut);

        svg.select('.x.axis')
          .call(x_axis)
          .attr("id", "tags")
          .selectAll('text')
          .attr('transform', 'rotate(30)')
          .attr('y', '10')
          .attr('x', '0')
          .style("text-anchor", "start");

        svg.select('.y.axis')
          .attr("id", "tags")
          .call(y_axis);

        svg.select('.x.axis')
          .call(x_axis)
          .selectAll('text')
          .attr('transform', 'rotate(30)')
          .attr('y', '10')
          .attr('x', '0')
          .style("text-anchor", "start");

        svg.select('.y.axis')
          .call(y_axis)

        function mouseOver(d) {
          var date = dateParse(d.date);
          var displayDate = tooltipFormat(date)
          var value_function = d.value;

          d3.select(this)
            .transition()
            .style('opacity', 1);

          tooltip
            .style('display', null)
            .html('<p>UK debt was ' + value_function + '% of GDP in quarter ending ' + displayDate + '</p>');
        }

        function mouseMove(d) {
          tooltip
            .style('top', (d3.event.pageY - 20) + "px")
            .style('left', (d3.event.pageX + 20) + "px");
        }

        function mouseOut(d) {
          d3.select(this)
            .transition()
            .style('opacity', 1);

          tooltip
            .style('display', 'none');

        }

      }
    });
  });

  $(document).on('submit', '#deficit', function(e) {
    e.preventDefault();

    $.ajax({
      url: "/data/deficit/",
      type: "POST", // or "get"
      data: {
        years: $('#select_dropdown').val(),
        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
      },
      success: function data(data) {
        console.log(data)

        svg.selectAll('#tags')
          .remove()

        svg.append("text")
          .attr("id", "tags")
          .attr("x", (width / 2))
          .attr("y", 0 - (margin.top / 2))
          .attr("text-anchor", "middle")
          .style("font-size", "18px")
          .text("UK's deficit is decreasing");
        //
        svg.append("text")
          .attr("id", "tags")
          .attr("transform", "rotate(-90)")
          .attr("y", 10 - margin.left)
          .attr("x", 0 - (height / 2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text("Gov Net Borrowing as % of GDP");
        //
        svg.append("text")
          .attr("id", "tags")
          .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.top + 5) + ")")
          .style("text-anchor", "middle")
          .text("Fiscal Year ending March");

        // add the X gridlines
        svg.append("g")
          .attr("id", "tags")
          .attr("class", "grid")
          .attr("transform", "translate(0," + height + ")")
          .call(make_x_gridlines()
            .tickSize(-height)
            .tickFormat("")
          );
        // add the Y gridlines
        svg.append("g")
          .attr("id", "tags")
          .attr("class", "grid")
          .call(make_y_gridlines()
            .tickSize(-width)
            .tickFormat("")
          );
        var dateParse = d3.timeParse('%Y %b');
        var tooltipFormat = d3.timeFormat('%b %Y');

        var x = d3.scaleBand()
          .range([0, width])
          .padding(0.1);

        var y = d3.scaleLinear()
          .range([height, 0]);

        x.domain(data.map(function(d) {
          console.log(d.date)
          return d.date;
        }));

        y.domain([0, d3.max(data, function(d) {
          console.log(d.value)
          return parseFloat(d.value);
        })]);

        svg.selectAll(".bar")
          .data(data)
          .enter().append("rect")
          .attr("class", "bar")
          .attr("id", "tags")
          .attr("x", function(d) {
            console.log(d.date)
            return x(d.date);
          })
          .attr("width", x.bandwidth())
          .attr("y", function(d) {
            console.log(d.value)
            return y(parseFloat(d.value));
          })
          .attr("height", function(d) {
            console.log(d.value)
            return height - y(parseFloat(d.value));
          })
          .on('mouseover', mouseOver)
          .on('mousemove', mouseMove)
          .on('mouseout', mouseOut);

        // add the x Axis
        svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .attr("id", "tags")
          .call(d3.axisBottom(x))
          .selectAll('text')
          .attr('transform', 'rotate(30)')
          .attr('y', '6')
          .attr('x', '30');

        // add the y Axis
        svg.append("g")
          .attr("id", "tags")
          .call(d3.axisLeft(y));

        function mouseOver(d) {
          var date = dateParse(d.date);
          var displayDate = tooltipFormat(date)
          var value_function = d.value;

          d3.select(this)
            .transition()
            .style('opacity', 1);

          tooltip
            .style('display', null)
            .html('<p>UK deficit was ' + value_function + '% of GDP in ' + displayDate + '</p>');
        }

        function mouseMove(d) {
          tooltip
            .style('top', (d3.event.pageY - 20) + "px")
            .style('left', (d3.event.pageX + 20) + "px");
        }

        function mouseOut(d) {
          d3.select(this)
            .transition()
            .style('opacity', 1);

          tooltip
            .style('display', 'none');

        }
      }
    });
  });
</script>

</html>
